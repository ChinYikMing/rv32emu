name: CI

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-code-related-file-changes:
    runs-on: ubuntu-24.04
    outputs:
      has_code_related_changes: ${{ steps.set_has_code_related_changes.outputs.has_code_related_changes }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
      - name: Test changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
              .ci/**
              build/**
              mk/**
              src/**
              tests/**
              tools/**
              .clang-format
              Dockerfile
              Makefile
      - name: Set has_code_related_changes
        id: set_has_code_related_changes
        run: |
          if [[ ${{ steps.changed-files.outputs.any_changed }} == true ]]; then
            echo "has_code_related_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_code_related_changes=false" >> $GITHUB_OUTPUT
          fi

  host-x64:
    needs: [detect-code-related-file-changes]
    if: needs.detect-code-related-file-changes.outputs.has_code_related_changes == 'true'
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc, clang]
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Cache LLVM 18
      id: cache-llvm
      uses: actions/cache@v4
      with:
        path: /usr/lib/llvm-18
        key: ${{ runner.os }}-${{ runner.arch }}-llvm-18-v2
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-llvm-18-

    - name: Cache RISC-V Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/toolchain
        key: ${{ runner.os }}-${{ runner.arch }}-riscv-toolchain-${{ hashFiles('.ci/riscv-toolchain-install.sh') }}

    - name: Install dependencies
      run: |
            set +e  # Disable errexit
            # Configure apt to tolerate mirror sync failures
            sudo tee /etc/apt/apt.conf.d/99-ci-reliability > /dev/null << 'EOF'
            APT::Update::Error-Mode "any";
            Acquire::IndexTargets::deb::DEP-11::DefaultEnabled "false";
            Acquire::IndexTargets::deb::DEP-11-icons::DefaultEnabled "false";
            Acquire::IndexTargets::deb::DEP-11-icons-hidpi::DefaultEnabled "false";
            Acquire::Retries "3";
            Acquire::Check-Valid-Until "false";
            EOF
            # Update with error tolerance
            sudo apt-get update -q=2 2>&1
            UPDATE_EXIT=$?
            if [ $UPDATE_EXIT -ne 0 ]; then
              echo "WARNING: apt update exited with code $UPDATE_EXIT, continuing..."
            fi
            sudo apt-get install -q=2 curl libsdl2-dev libsdl2-mixer-dev device-tree-compiler expect bc p7zip-full
            set -e  # Re-enable errexit
      shell: bash

    - name: Install RISC-V Toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
            .ci/riscv-toolchain-install.sh

    - name: Setup RISC-V Toolchain PATH
      run: echo "${{ github.workspace }}/toolchain/bin" >> $GITHUB_PATH

    - name: Install LLVM 18
      if: steps.cache-llvm.outputs.cache-hit != 'true'
      run: |
            .ci/fetch.sh -q -o llvm.sh https://apt.llvm.org/llvm.sh
            chmod +x ./llvm.sh
            sudo ./llvm.sh 18

    - name: Setup LLVM PATH
      run: echo "/usr/lib/llvm-18/bin" >> $GITHUB_PATH
      shell: bash

    - name: Install compiler
      id: install_cc
      uses: rlalik/setup-cpp-compiler@master
      with:
        compiler: ${{ matrix.compiler }}
    - name: Setup emsdk
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.51
        actions-cache-folder: 'emsdk-cache'
    - name: Set parallel jobs variable
      run: |
            echo "PARALLEL=-j$(nproc)" >> "$GITHUB_ENV"
            echo "BOOT_LINUX_TEST=TMP_FILE=\$(mktemp "$RUNNER_TEMP/tmpfile.XXXXXX"); \
                                  sudo env TMP_FILE=\${TMP_FILE} .ci/boot-linux-prepare.sh setup; \
                                  . \${TMP_FILE}; \
                                  .ci/boot-linux.sh; \
                                  EXIT_CODE=\$?; \
                                  sudo env TMP_FILE=\${TMP_FILE} BLK_DEV_EXT4=\${BLK_DEV_EXT4} \
                                           BLK_DEV_SIMPLEFS=\${BLK_DEV_SIMPLEFS} .ci/boot-linux-prepare.sh cleanup; \
                                  exit \${EXIT_CODE};" >> "$GITHUB_ENV"
    - name: default build using emcc
      if: success()
      run: |
            make CC=emcc ENABLE_JIT=0 $PARALLEL
