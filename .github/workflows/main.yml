name: CI

on: [push, pull_request]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  detect-code-related-file-changes:
    runs-on: ubuntu-24.04
    outputs:
      has_code_related_changes: ${{ steps.set_has_code_related_changes.outputs.has_code_related_changes }}
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4
      - name: Test changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
        with:
          files: |
              .ci/**
              build/**
              mk/**
              src/**
              tests/**
              tools/**
              .clang-format
              Dockerfile
              Makefile
      - name: Set has_code_related_changes
        id: set_has_code_related_changes
        run: |
          if [[ ${{ steps.changed-files.outputs.any_changed }} == true ]]; then
            echo "has_code_related_changes=true" >> $GITHUB_OUTPUT
          else
            echo "has_code_related_changes=false" >> $GITHUB_OUTPUT
          fi

  host-x64:
    needs: [detect-code-related-file-changes]
    if: needs.detect-code-related-file-changes.outputs.has_code_related_changes == 'true'
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        compiler: [gcc]
    runs-on: ubuntu-24.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: 'true'

    - name: Cache LLVM 18
      id: cache-llvm
      uses: actions/cache@v4
      with:
        path: /usr/lib/llvm-18
        key: ${{ runner.os }}-${{ runner.arch }}-llvm-18-v2
        restore-keys: |
          ${{ runner.os }}-${{ runner.arch }}-llvm-18-

    - name: Cache RISC-V Toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: ${{ github.workspace }}/toolchain
        key: ${{ runner.os }}-${{ runner.arch }}-riscv-toolchain-${{ hashFiles('.ci/riscv-toolchain-install.sh') }}

    - name: Install dependencies
       run: |
             apt install dtc

    - name: Install compiler
      id: install_cc
      uses: rlalik/setup-cpp-compiler@master
      with:
        compiler: ${{ matrix.compiler }}
    - name: Setup emsdk
      uses: mymindstorm/setup-emsdk@v14
      with:
        version: 3.1.51
        actions-cache-folder: 'emsdk-cache'
    - name: Set parallel jobs variable
      run: |
            echo "PARALLEL=-j$(nproc)" >> "$GITHUB_ENV"
            echo "BOOT_LINUX_TEST=TMP_FILE=\$(mktemp "$RUNNER_TEMP/tmpfile.XXXXXX"); \
                                  sudo env TMP_FILE=\${TMP_FILE} .ci/boot-linux-prepare.sh setup; \
                                  . \${TMP_FILE}; \
                                  .ci/boot-linux.sh; \
                                  EXIT_CODE=\$?; \
                                  sudo env TMP_FILE=\${TMP_FILE} BLK_DEV_EXT4=\${BLK_DEV_EXT4} \
                                           BLK_DEV_SIMPLEFS=\${BLK_DEV_SIMPLEFS} .ci/boot-linux-prepare.sh cleanup; \
                                  exit \${EXIT_CODE};" >> "$GITHUB_ENV"
    - name: Cache build artifacts
      uses: actions/cache@v4
      with:
        path: build/
        key: rv32emu-artifacts-${{ runner.os }}-${{ hashFiles('mk/artifact.mk', 'mk/external.mk') }}
        restore-keys: |
          rv32emu-artifacts-${{ runner.os }}-

    - name: Fetch artifacts
      env:
        CC: ${{ steps.install_cc.outputs.cc }}
      run: |
            make artifact
            make ENABLE_SYSTEM=1 artifact
            make ENABLE_ARCH_TEST=1 artifact
            # get from rv32emu-prebuilt
            .ci/fetch.sh -o build/shareware_doom_iwad.zip "https://raw.githubusercontent.com/sysprog21/rv32emu-prebuilt/doom-artifact/shareware_doom_iwad.zip"
            unzip -o -d build/ build/shareware_doom_iwad.zip

    - name: default build using emcc
      if: success()
      run: |
            make distclean
            make CC=emcc ENABLE_JIT=0 $PARALLEL

    - name: default build for system emulation using emcc
      if: success()
      run: |
            make distclean
            make CC=emcc ENABLE_SYSTEM=1 ENABLE_JIT=0 $PARALLEL
            make distclean ENABLE_SYSTEM=1
